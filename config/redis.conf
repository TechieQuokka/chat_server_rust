# ============================================
# Redis Configuration for Chat Server
# Development Environment
# ============================================

# ============================================
# Network Settings
# ============================================
bind 0.0.0.0
port 6379
protected-mode no
tcp-backlog 511
timeout 0
tcp-keepalive 300

# ============================================
# General Settings
# ============================================
daemonize no
supervised no
pidfile /var/run/redis/redis-server.pid
loglevel notice
logfile ""
databases 16
always-show-logo no

# ============================================
# Snapshotting (RDB Persistence)
# ============================================
# Save to disk:
#   after 900 sec (15 min) if at least 1 key changed
#   after 300 sec (5 min) if at least 10 keys changed
#   after 60 sec if at least 10000 keys changed
save 900 1
save 300 10
save 60 10000

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# ============================================
# AOF Persistence (Append Only File)
# ============================================
appendonly yes
appendfilename "appendonly.aof"
appenddirname "appendonlydir"

# fsync policy:
#   always - fsync after every write (slowest, safest)
#   everysec - fsync every second (good balance)
#   no - let OS handle it (fastest, less safe)
appendfsync everysec

no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# ============================================
# Memory Management
# ============================================
maxmemory 512mb

# Eviction policy when maxmemory is reached:
#   volatile-lru - Remove LRU keys with expire set
#   allkeys-lru - Remove any LRU key
#   volatile-lfu - Remove LFU keys with expire set
#   allkeys-lfu - Remove any LFU key
#   volatile-random - Remove random key with expire set
#   allkeys-random - Remove any random key
#   volatile-ttl - Remove key with nearest expire time
#   noeviction - Don't evict, return error on write
maxmemory-policy allkeys-lru

maxmemory-samples 5

# ============================================
# Lazy Freeing
# ============================================
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# ============================================
# Client Output Buffer Limits
# ============================================
# Syntax: client-output-buffer-limit <class> <hard limit> <soft limit> <soft seconds>
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ============================================
# Pub/Sub Settings
# ============================================
# Enable keyspace notifications for expired keys
# E - Keyevent events, published with __keyevent@<db>__ prefix
# x - Expired events (events generated every time a key expires)
notify-keyspace-events Ex

# ============================================
# Slow Log
# ============================================
# Log queries that take longer than 10ms
slowlog-log-slower-than 10000
# Keep last 128 slow queries
slowlog-max-len 128

# ============================================
# Latency Monitor
# ============================================
latency-monitor-threshold 100

# ============================================
# Hash Settings
# ============================================
hash-max-listpack-entries 512
hash-max-listpack-value 64

# ============================================
# List Settings
# ============================================
list-max-listpack-size -2
list-compress-depth 0

# ============================================
# Set Settings
# ============================================
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64

# ============================================
# Sorted Set Settings
# ============================================
zset-max-listpack-entries 128
zset-max-listpack-value 64

# ============================================
# HyperLogLog Settings
# ============================================
hll-sparse-max-bytes 3000

# ============================================
# Streams Settings
# ============================================
stream-node-max-bytes 4096
stream-node-max-entries 100

# ============================================
# Active Rehashing
# ============================================
activerehashing yes

# ============================================
# Client Query Buffer
# ============================================
# client-query-buffer-limit 1gb

# ============================================
# Proto Max Bulk Length
# ============================================
# proto-max-bulk-len 512mb

# ============================================
# Active Defrag (requires jemalloc)
# ============================================
# activedefrag no
# active-defrag-ignore-bytes 100mb
# active-defrag-threshold-lower 10
# active-defrag-threshold-upper 100
# active-defrag-cycle-min 1
# active-defrag-cycle-max 25
# active-defrag-max-scan-fields 1000

# ============================================
# Security (Development - No Auth)
# ============================================
# requirepass your_password_here
# For production, enable authentication:
# requirepass chat_redis_secret_password

# ============================================
# Disable Dangerous Commands (Production)
# ============================================
# For production, consider renaming or disabling:
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command DEBUG ""
# rename-command CONFIG ""

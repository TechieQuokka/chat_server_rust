name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Job 1: Code Quality and Testing
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: chat_server_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-target-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build project
        run: cargo build --verbose --all-features

      - name: Run tests
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/chat_server_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_key_for_ci_testing
          RUST_LOG: debug
        run: cargo test --verbose --all-features

      - name: Generate test coverage (optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cargo install cargo-tarpaulin || true
          cargo tarpaulin --out Xml --output-dir ./coverage || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/debug/
            coverage/
          retention-days: 7

  # Job 2: Security Scanning
  security-scan:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: ${{ runner.os }}-cargo-audit

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked || true

      - name: Run security audit
        run: cargo audit --deny warnings || true
        continue-on-error: true

      - name: Cache cargo deny
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-deny
          key: ${{ runner.os }}-cargo-deny

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked || true

      - name: Run cargo deny
        run: |
          if [ -f "deny.toml" ]; then
            cargo deny check
          else
            echo "deny.toml not found, skipping cargo deny check"
          fi
        continue-on-error: true

      - name: Check for known vulnerabilities
        uses: actions-rust-lang/audit@v1
        with:
          denyWarnings: false

  # Job 3: Docker Build and Push
  docker-build:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Create Dockerfile if not exists
        run: |
          if [ ! -f "Dockerfile" ]; then
            cat > Dockerfile << 'EOF'
          # Build stage
          FROM rust:1.75-slim as builder

          WORKDIR /app

          # Install dependencies
          RUN apt-get update && apt-get install -y \
              pkg-config \
              libssl-dev \
              && rm -rf /var/lib/apt/lists/*

          # Copy manifests
          COPY Cargo.toml Cargo.lock ./

          # Create dummy main to cache dependencies
          RUN mkdir src && echo "fn main() {}" > src/main.rs
          RUN cargo build --release || true
          RUN rm -rf src

          # Copy source code
          COPY . .

          # Build application
          RUN cargo build --release

          # Runtime stage
          FROM debian:bookworm-slim

          WORKDIR /app

          # Install runtime dependencies
          RUN apt-get update && apt-get install -y \
              ca-certificates \
              libssl3 \
              && rm -rf /var/lib/apt/lists/*

          # Copy binary from builder
          COPY --from=builder /app/target/release/chat-server /usr/local/bin/chat-server

          # Create non-root user
          RUN useradd -m -u 1000 chatserver && \
              chown -R chatserver:chatserver /app

          USER chatserver

          EXPOSE 3000

          CMD ["chat-server"]
          EOF
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # Job 4: Release (on tags only)
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binaries
        run: |
          cargo build --release --locked
          mkdir -p release
          cp target/release/chat-server release/
          cd release
          tar -czf chat-server-linux-x86_64.tar.gz chat-server
          sha256sum chat-server-linux-x86_64.tar.gz > chat-server-linux-x86_64.tar.gz.sha256

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## Changes

            ${{ steps.changelog.outputs.changes }}

            ## Docker Images

            Pull the Docker image:
            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ```

            Or use the latest tag:
            ```bash
            docker pull ghcr.io/${{ github.repository }}:latest
            ```

            ## Installation

            Download the binary for your platform and extract it:
            ```bash
            tar -xzf chat-server-linux-x86_64.tar.gz
            chmod +x chat-server
            ./chat-server
            ```
          files: |
            release/chat-server-linux-x86_64.tar.gz
            release/chat-server-linux-x86_64.tar.gz.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 5: Notify on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, docker-build]
    if: failure()

    steps:
      - name: Notify failure
        run: |
          echo "CI/CD Pipeline failed. Please check the logs for details."
          echo "Failed jobs:"
          echo "  - Build & Test: ${{ needs.build-and-test.result }}"
          echo "  - Security Scan: ${{ needs.security-scan.result }}"
          echo "  - Docker Build: ${{ needs.docker-build.result }}"

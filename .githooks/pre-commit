#!/bin/bash
# ============================================
# Pre-commit Hook
# Chat Server Project
# ============================================
#
# This hook runs before each commit to ensure code quality.
# It performs the following checks:
#   1. Format verification (cargo fmt --check)
#   2. Lint checks (cargo clippy)
#   3. Unit tests (cargo test --lib)
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# Or manually copy to:
#   cp .githooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
# ============================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print section header
print_header() {
    echo -e "${BLUE}============================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}============================================${NC}"
}

# Print success message
print_success() {
    echo -e "${GREEN}[PASS]${NC} $1"
}

# Print error message
print_error() {
    echo -e "${RED}[FAIL]${NC} $1"
}

# Print warning message
print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_header "Running Pre-commit Checks"

# Track overall status
CHECKS_PASSED=true

# ============================================
# Step 1: Check Formatting
# ============================================
echo ""
echo -e "${YELLOW}Step 1/3:${NC} Checking code formatting..."

if cargo fmt -- --check; then
    print_success "Code formatting is correct"
else
    print_error "Code formatting issues detected"
    echo ""
    echo "To fix formatting issues, run:"
    echo "  cargo fmt"
    echo ""
    CHECKS_PASSED=false
fi

# ============================================
# Step 2: Run Clippy
# ============================================
echo ""
echo -e "${YELLOW}Step 2/3:${NC} Running Clippy lints..."

if cargo clippy --all-targets --all-features -- -D warnings 2>&1; then
    print_success "Clippy checks passed"
else
    print_error "Clippy found issues"
    echo ""
    echo "Please fix the clippy warnings before committing."
    echo "You can run 'cargo clippy --fix' to auto-fix some issues."
    echo ""
    CHECKS_PASSED=false
fi

# ============================================
# Step 3: Run Unit Tests
# ============================================
echo ""
echo -e "${YELLOW}Step 3/3:${NC} Running unit tests..."

if cargo test --lib --quiet; then
    print_success "All unit tests passed"
else
    print_error "Some unit tests failed"
    echo ""
    echo "Please fix failing tests before committing."
    echo "Run 'cargo test --lib' for detailed output."
    echo ""
    CHECKS_PASSED=false
fi

# ============================================
# Final Status
# ============================================
echo ""
print_header "Pre-commit Check Results"

if [ "$CHECKS_PASSED" = true ]; then
    echo -e "${GREEN}All checks passed! Proceeding with commit.${NC}"
    exit 0
else
    echo -e "${RED}Some checks failed. Please fix the issues and try again.${NC}"
    echo ""
    echo "To bypass this hook (not recommended), use:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

#!/bin/bash
# ============================================
# Commit Message Hook
# Chat Server Project
# ============================================
#
# This hook validates that commit messages follow the
# Conventional Commits specification.
#
# Format: <type>(<scope>): <subject>
#
# Types:
#   feat     - New feature
#   fix      - Bug fix
#   docs     - Documentation changes
#   style    - Code style changes (formatting, etc.)
#   refactor - Code refactoring
#   perf     - Performance improvements
#   test     - Test additions or modifications
#   chore    - Build process, tooling changes
#
# Examples:
#   feat(auth): add JWT refresh token rotation
#   fix(ws): handle reconnection race condition
#   docs(api): update REST endpoint documentation
#   refactor(db): extract repository trait
#
# To install this hook:
#   git config core.hooksPath .githooks
# ============================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get the commit message file
COMMIT_MSG_FILE=$1

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Get just the first line (subject)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)

# ============================================
# Validation Patterns
# ============================================

# Valid commit types
TYPES="feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert"

# Pattern for conventional commit format
# Format: type(scope): subject
# - type: required, one of the valid types
# - (scope): optional, any text in parentheses
# - subject: required, 1-72 characters
PATTERN="^($TYPES)(\(.+\))?: .{1,72}$"

# Pattern for merge commits (allow them through)
MERGE_PATTERN="^Merge "

# Pattern for revert commits
REVERT_PATTERN="^Revert \""

# ============================================
# Validation
# ============================================

# Skip validation for merge commits
if echo "$FIRST_LINE" | grep -qE "$MERGE_PATTERN"; then
    echo -e "${GREEN}[OK]${NC} Merge commit detected, skipping validation"
    exit 0
fi

# Skip validation for revert commits
if echo "$FIRST_LINE" | grep -qE "$REVERT_PATTERN"; then
    echo -e "${GREEN}[OK]${NC} Revert commit detected, skipping validation"
    exit 0
fi

# Validate the commit message format
if echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo -e "${GREEN}[OK]${NC} Commit message format is valid"
    exit 0
fi

# ============================================
# Error Output
# ============================================

echo ""
echo -e "${RED}============================================${NC}"
echo -e "${RED}Invalid Commit Message Format${NC}"
echo -e "${RED}============================================${NC}"
echo ""
echo -e "Your commit message:"
echo -e "${YELLOW}  $FIRST_LINE${NC}"
echo ""
echo "Expected format:"
echo "  <type>(<scope>): <subject>"
echo ""
echo "Valid types:"
echo "  feat     - New feature"
echo "  fix      - Bug fix"
echo "  docs     - Documentation changes"
echo "  style    - Code style changes (formatting, etc.)"
echo "  refactor - Code refactoring"
echo "  perf     - Performance improvements"
echo "  test     - Test additions or modifications"
echo "  chore    - Build process, tooling changes"
echo "  build    - Build system changes"
echo "  ci       - CI configuration changes"
echo "  revert   - Revert a previous commit"
echo ""
echo "Rules:"
echo "  - Type is required"
echo "  - Scope is optional but recommended"
echo "  - Subject must be 1-72 characters"
echo "  - Use imperative mood (\"add\" not \"added\")"
echo ""
echo "Examples:"
echo -e "  ${GREEN}feat(auth): add JWT refresh token rotation${NC}"
echo -e "  ${GREEN}fix(ws): handle reconnection race condition${NC}"
echo -e "  ${GREEN}docs(api): update REST endpoint documentation${NC}"
echo -e "  ${GREEN}refactor(db): extract repository trait${NC}"
echo -e "  ${GREEN}test(user): add unit tests for validation${NC}"
echo ""
echo "To bypass this hook (not recommended), use:"
echo "  git commit --no-verify"
echo ""

exit 1
